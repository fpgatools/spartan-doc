# FPGA design flow

...how it is realised in the YoSys + Arachne + iCEstorm toolchain
and
how it could be realised for the Xilinx Spartan-6 toolchain.

## Synthesis

Synthesis in general compiles a **hardware description** language
to a netlist of **logic primitives**, e.g. LUTs and D-Flipflops,
and proceeds by **mapping** those primitives to device-specific primitives, e.g. SB_LUT4 for iCE40 FPGAs.
Amongst other things,
YoSys is capable of compiling Verilog
to most of the primitives that are available in Lattice iCE40-FPGAs.
The output of the synthesis is the netlist
containing a list of FPGA tiles with (abstract) configuration
alongside information about how to interconnect the inputs and outputs of those tiles.

Excerpt from a **BLIF** netlist generated by **YoSys**:
```blif
...
.gate SB_LUT4 I0=mysignal1 I1=mysignal2 I2=mysignal3 I3=mysignal4 O=myderivedsignal
.param LUT_INIT 0000111110111011
...
```
The above example shows the BLIF representation of an iCE40 lookup table (SB_LUT4)
as it was generated by YoSys.
The above LUT gets four inputs signals (I0-4) and provides one output signal (O).
In the second line the corresponding lookup table values are configured
(which determine how the output signal is logically derived from the input signals).

The outputs of a primitive are input to one or several others.
The totality of interconnected primitives
realizes the desired logical flow.
Tile interconnections are thereby called nets.
Nets can only represent one signal
and thus only have one logical/electrical value at a time,
but they can connect two or more inputs with one output.
Nets are identified by their name.
Some net names are derived from the design source and therefore human-readable,
others are generated by the synthesis tool to interconnect infered tiles.

## Place and Route (PnR)

The place-and-route is started
with specific information which FPGA device to place for.
It imports the (device-specific) **netlist**,
and elaborates a possible **floorplan**,
usually via methods of simulated annealing.
The floorplan contains explicit configuration information
about all tiles
present on an FPGA.
This information can be abstract, as in the netlist,
or binary, with the abstract tile configuration already transpiled to a stream of bits.

**Arachne-PnR** is capable of importing BLIF netlists
generated by YoSys
and place all iCE40 FPGA tiles on a given FPGA.
The output is usually a .asc file,
which contains an ASCII representation of of all FPGA tiles
(even the ones not used be the individual design)
alongside their corresponding tile configuration bits.

```asc
.comment arachne-pnr 0.1+262+1 (git sha1 5403777, g++ 7.2.0-19 -O3 -DNDEBUG)
.device 5k
.io_tile 1 0
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000100
000000000000001000
.io_tile 2 0
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000000
000000000000000100
000000000000001000
.io_tile 3 0
...
```

## Bitstream Packing

Once the **floorplan** for an FPGA has been elaborated,
there is little left to do but to pack the generated configuration
into a file,
that can be stored either in the FPGA itself
or in a non-volatile memory IC connected to the FPGA.
In the latter case,
the FPGA reads the memory IC upon startup
and configures itself from the contained binary,
which is mostly referred to as the **bitstream**.
Those memory ICs are usually connected via a serial bus (SPI).

The **iCEstorm project** provides the tool **icepack**,
which facilitates the conversion
from the ASCII representation of the floorplan
to the bitstream.

# Platforms
...suitable for testing bitstreams generated for Spartan-6 FPGAs.

## Mojo-v3 FPGA development board
* Homepage: https://embeddedmicro.com/products/mojo-v3
  * Schematic: http://cdn.embeddedmicro.com/mojo/v3-sch.pdf
  * Eagle files: http://cdn.embeddedmicro.com/mojo/mojo-eagle-v3.zip
  * Ressources on GitHub: https://github.com/embmicro
* buy directly from EmbeddedMicro, or e.g. from EXP-Tech:
  * https://www.exp-tech.de/plattformen/fpga/5202/mojo-v3-fpga-development-board
  * possibly with https://www.exp-tech.de/module/sonstige/7556/mojo-io-shield

## ZTEX USB-FPGA 1.15
* Homepage: https://www.ztex.de/usb-fpga-1/usb-fpga-1.15y.e.html

# Links
* Details about Spartan-6 bitstreams: https://vjordan.info/log/fpga/bitstream-analysis-code.html#id7
